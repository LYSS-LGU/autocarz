<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>AutoCarz Dashboard</title>

    <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="autocarz.css" />

    <!-- Leaflet ì§€ë„ ì „ìš© ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="leaflet-style.css" />

    <!-- Leaflet ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- ì¹´ì¹´ì˜¤ë§µ API (JavaScript í‚¤ í•„ìš”) -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c739c0f81dfa880de4e29da416515953"></script>
  </head>
  <body>
    <h1>ğŸš— AutoCarz ëŒ€ì‹œë³´ë“œ</h1>

    <!-- ğŸ”„ ì¹´ë©”ë¼ + ì§€ë„ + íƒ€ì„ë¼ì¸ ì¢Œìš°ë°°ì¹˜ -->
    <div class="map-row">
      <!-- ğŸ”´ ì™¼ìª½: ì¹´ë©”ë¼ -->
      <div class="left-panel">
        <h2>ì¹´ë©”ë¼ ë¯¸ë¦¬ë³´ê¸°</h2>
        <video id="camera" autoplay muted></video>
        <br />
        <button onclick="toggleCamera()">ì¹´ë©”ë¼ On/Off</button>
        <button onclick="capturePhoto()">ğŸ“¸ ì‚¬ì§„ ì°ê¸°</button>
        <canvas id="snapshot" style="display: none"></canvas>
      </div>

      <!-- ğŸ—º ì˜¤ë¥¸ìª½: ì§€ë„ + íƒ€ì„ë¼ì¸ -->
      <div class="right-panel">
        <h2>ì¹´ì¹´ì˜¤ë§µ - í˜„ì¬ ìœ„ì¹˜</h2>
        <div id="kakaomap"></div>

        <h2>ğŸ¦Š ì•¼ìƒë™ë¬¼ ê²½ê³  ì§€ë„ (Leaflet)</h2>
        <div id="leafletmap"></div>

        <h2>ğŸ“ ì‚¬ì§„ ì´¬ì˜ ìœ„ì¹˜ íƒ€ì„ë¼ì¸</h2>
        <div id="photo-location-list"></div>
      </div>
    </div>

    <!-- ğŸ“· ì¹´ë©”ë¼ ë° ìœ„ì¹˜ ì—°ë™ -->
    <script>
      let stream = null;
      let leafletMap;

      async function toggleCamera() {
        const video = document.getElementById("camera");
        if (!stream) {
          try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
          } catch (e) {
            alert("ì¹´ë©”ë¼ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.");
          }
        } else {
          stream.getTracks().forEach((track) => track.stop());
          video.srcObject = null;
          stream = null;
        }
      }

      function capturePhoto() {
        const video = document.getElementById("camera");
        const canvas = document.getElementById("snapshot");
        const context = canvas.getContext("2d");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        // ğŸŸ¡ ì—¬ê¸°ì— ìŒì„± ê²½ê³  + ì§„ë™ ì¶”ê°€
        const message = new SpeechSynthesisUtterance(
          "ì‹ ê³  ì ‘ìˆ˜ê°€ ì™„ë£Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¤ëŠ˜ í•˜ë£¨ë„ ê³ ìƒí•˜ì…¨ìŠµë‹ˆë‹¤."
        );
        message.lang = "ko-KR";
        window.speechSynthesis.speak(message);

        if (navigator.vibrate) {
          navigator.vibrate([300, 100, 300]);
        }

        // GPS + ë§ˆì»¤ í‘œì‹œ
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = parseFloat(pos.coords.latitude.toFixed(6));
          const lon = parseFloat(pos.coords.longitude.toFixed(6));
          const timestamp = new Date().toLocaleString();

          // íƒ€ì„ë¼ì¸ í‘œì‹œ
          const entry = document.createElement("div");
          entry.className = "photo-log-entry";
          entry.innerText = `ğŸ“¸ [${timestamp}] ìœ„ë„: ${lat}, ê²½ë„: ${lon}`;
          document.getElementById("photo-location-list").prepend(entry);

          // Leaflet ì§€ë„ ë§ˆì»¤ + ê²½ê³  ë°˜ê²½
          if (leafletMap) {
            const latlng = [lat, lon];

            L.marker(latlng)
              .addTo(leafletMap)
              .bindPopup("ğŸ¦Š ì•¼ìƒë™ë¬¼ ë°œê²¬ ìœ„ì¹˜")
              .openPopup();

            L.circle(latlng, {
              color: "red",
              fillColor: "#f03",
              fillOpacity: 0.3,
              radius: 3000,
            }).addTo(leafletMap);

            L.circle(latlng, {
              color: "orange",
              fillColor: "#fa0",
              fillOpacity: 0.15,
              radius: 5000,
            }).addTo(leafletMap);

            leafletMap.setView(latlng, 13);
          }
        });
      }
    </script>

    <!-- ğŸ§­ ì¹´ì¹´ì˜¤ë§µ ì—°ë™ -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c739c0f81dfa880de4e29da416515953"></script>
    <script>
      navigator.geolocation.getCurrentPosition((pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const container = document.getElementById("kakaomap");
        const options = {
          center: new kakao.maps.LatLng(lat, lon),
          level: 3,
        };
        const map = new kakao.maps.Map(container, options);
        new kakao.maps.Marker({
          position: new kakao.maps.LatLng(lat, lon),
          map: map,
        });
      });

      // Leaflet ì§€ë„ ì´ˆê¸°í™”
      window.addEventListener("DOMContentLoaded", () => {
        leafletMap = L.map("leafletmap").setView([37.5665, 126.978], 16);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "Â© OpenStreetMap contributors",
        }).addTo(leafletMap);
      });
    </script>
  </body>
</html>
